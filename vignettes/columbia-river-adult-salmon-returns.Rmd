---
title: "Data Exploration: Columbia River Adult Salmon Returns"
author: "[Jim Tyhurst](https://www.jimtyhurst.com/)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
numbersections: true
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

<span style="color:red">_Work in Process_ ...</span>

## Configuration
```{r}
library(salmonstats)
library(glue)
library(tidyverse)
```

## Data preparation

Daily counts were obtained by manually selecting search parameters from the [Fish Passage Center](http://www.fpc.org/)'s [Adult Data Query](http://www.fpc.org/web/apps/adultsalmon/Q_adultcounts_dataquery.php) page:

* _passage reporting site_ : This exploration uses observations from the [Bonneville Dam](https://www.nwp.usace.army.mil/bonneville/), which is abbreviated as 'BON' in the 'Dam' column of the data.
* _species_ : I always left the default value 'All Species'.
* _start date_ : I always selected 'January 1' of the selected year.
* _end date_ : I always selected 'December 31' of the selected year.

After downloading each file of data, the final two lines of each file needed to be deleted, because they were annotations that were _not_ part of the data to be analyzed. Then I changed the name of the files to match this pattern:

> fpc-salmon-{passage_reporting_site_abbreviation}-{year}0101-{year}1231.csv

For example, the following files are for data from Bonneville Dam (BON) from years 2000 and 2015, respectively:

> fpc_salmon-BON-20000101-20001231.csv  
> fpc_salmon-BON-20150101-20001231.csv

Metadata is available from the [Fish Passage Center Adult Metadata](http://www.fpc.org/documents/metadata/FPC_Adult_Metadata.html) web page. In particular, Bonneville Dam data only has observations from March 15 to November 15 for years up to 2001. Starting in 2002, observations were made every day during the year.

<span style="color:red">_To Do_: There are quite a few daily count values that are negative. What does that mean?</span>

```{r message=FALSE}
# Replace the path components with the location of your data.
data_directory <- file.path("..", "inst", "extdata", "ColumbiaRiver-FishPassageCenter", "BonnevilleDam")

bon2005 <- get_fpc_data(2005, "BON", data_directory)
bon2015 <- get_fpc_data(2015, "BON", data_directory)
```

## Plots for Bonneville Dam for years 2005 and 2015

```{r fig.height = 6, fig.width = 8, fig.align = "center"}
plot_single_fpc_file(bon2005, 2005, "Bonneville Dam")
```

Chinook salmon run in spring and fall, as shown by the two bumps around days 120 and 250. The other species only have a single run per year.

```{r fig.height = 6, fig.width = 8, fig.align = "center"}
plot_single_fpc_file(bon2015, 2015, "Bonneville Dam")
```

Comparing these last two plots, I am surprised that the numbers for 2015 are so much bigger than for 2005.

## Plots for Bonneville Dam from 1990 to 2018

Each year of data is in one CSV file in a subdirectory of `inst/extdata` with a separate directory for each passage reporting site. Let's look at data for steelhead salmon first:

```{r message=FALSE}
first_year <- 1990
last_year <- 2018
passage_reporting_site_name <- "Bonneville Dam"
passage_reporting_site_code <- "BON"

# Concatenates the files into a single tibble.
steelhead <- first_year:last_year %>% 
  purrr::map(function(year) {get_fpc_data(year, passage_reporting_site_code, data_directory)}) %>% 
  purrr::reduce(function(x, y) {dplyr::bind_rows(x, y)}) %>% 
  dplyr::select(Dam, Year, DayOfYear, Steelhead)
dim(steelhead)
```

We plot a few years to get a feel for the distribution:

```{r fig.height = 6, fig.width = 8, fig.align = "center"}
steelhead %>% 
  dplyr::filter(Year %in% c(2000, 2005, 2010, 2015)) %>% 
  ggplot(aes(DayOfYear)) +
  geom_line(aes(y = Steelhead, color = factor(Year))) +
  ggtitle(
    glue("{passage_reporting_site}: Daily Count of Adult {species} Returns",
         passage_reporting_site = passage_reporting_site_name,
         species = "Steelhead")) +
  scale_x_continuous(name = "Day of Year", breaks = seq(0, 350, by = 50)) +
  scale_y_continuous(name = "Daily Count", limits = c(0, 10000), breaks = seq(0, 10000, by = 2000))
```

I am surprised that 2010 and 2015 have higher peaks than 2000 and 2005, because I thought that salmon numbers were descreasing. Let's look more closely at the yearly trend. In the next plot, we sum the daily observations, in order to compare total quantity for the whole year.

<span style="color:red">_To Do_: Revise the plots to only include data from March 15 to November 15 when comparing years before 2002 with years from 2002 and later, because years before 2002 only have data for those 8 months of the year.</span>

```{r fig.height = 6, fig.width = 8, fig.align = "center"}
steelhead %>% 
  dplyr::group_by(Year) %>% 
  dplyr::mutate(Quantity = sum(Steelhead)) %>%
  ggplot(aes(Year, Quantity)) +
  geom_bar(stat = "identity") +
  ggtitle(
    glue("{passage_reporting_site}: Total Adult {species} Returns",
         passage_reporting_site = passage_reporting_site_name,
         species = "Steelhead")) +
  scale_x_continuous(name = "Year", breaks = seq(1990, 2015, by = 5)) +
  scale_y_continuous(name = "Returns Counted", labels = function(x){format(x, scientific = FALSE, big.mark = ",")})
```

<span style="color:red">_To Do_: Extend this plot to earlier years.</span>

## References

Source code: https://github.com/jimtyhurst/salmonstats

Data source: http://www.fpc.org/web/apps/adultsalmon/Q_adultcounts_dataquery.php

Metadata: http://www.fpc.org/documents/metadata/FPC_Adult_Metadata.html
